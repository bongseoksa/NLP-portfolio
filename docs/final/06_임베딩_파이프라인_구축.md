# 06. 임베딩 파이프라인 구축

> **문서 버전**: v1.0
> **작성일**: 2026-01-05
> **이전 문서**: [05_데이터베이스_설정.md](./05_데이터베이스_설정.md)
> **다음 문서**: [07_API_서버_구축.md](./07_API_서버_구축.md)
> **예상 시간**: 15-30분 (레포지토리 크기에 따라)

---

## 📋 목차

1. [파이프라인 개요](#1-파이프라인-개요)
2. [GitHub Token 설정](#2-github-token-설정)
3. [OpenAI API 키 설정](#3-openai-api-키-설정)
4. [target-repos.json 설정](#4-target-reposjson-설정)
5. [로컬 파이프라인 실행](#5-로컬-파이프라인-실행)
6. [결과 검증](#6-결과-검증)
7. [GitHub Actions CI 설정](#7-github-actions-ci-설정)

---

## 1. 파이프라인 개요

### 1.1 통합 임베딩 파이프라인이란?

**Unified Embedding Pipeline**은 GitHub 레포지토리 데이터를 수집하고, 임베딩을 생성하여, 정적 벡터 파일로 export하는 **20단계 자동화 파이프라인**입니다.

### 1.2 파이프라인 실행 모드

```bash
# 일반 모드 (증분 업데이트)
pnpm run embed

# 리셋 모드 (전체 재생성)
pnpm run embed:reset
```

### 1.3 파이프라인 20단계

```
[Phase 1: Setup & Validation]
Step 1:  Configuration loading (target-repos.json)
Step 2:  Environment validation (API keys, paths)
Step 3:  Load commit state (증분 업데이트 준비)

[Phase 2: Data Collection]
Step 4:  Fetch commits (GitHub API)
Step 5:  Fetch commit diffs
Step 6:  Fetch repository files
Step 7:  Fetch Q&A history (Supabase)

[Phase 3: Embedding Generation]
Step 8:  Initialize embedding model (Hugging Face)
Step 9:  Generate commit embeddings
Step 10: Generate file embeddings
Step 11: Generate Q&A embeddings

[Phase 4: Vector Storage]
Step 12: Save to Supabase pgvector

[Phase 5: Data Cleanup]
Step 13: Age-based cleanup (6+ months)
Step 14: Deleted files cleanup
Step 15: Capacity limit enforcement (10MB)

[Phase 6: Export]
Step 16: Fetch all embeddings from Supabase
Step 17: Generate embeddings.json
Step 18: Compress to embeddings.json.gz

[Phase 7: Finalization]
Step 19: Update commit-state.json
Step 20: Save statistics and summary
```

---

## 2. GitHub Token 설정

### 2.1 Personal Access Token (PAT) 생성

1. GitHub 로그인
2. **Settings** → **Developer settings** → **Personal access tokens** → **Tokens (classic)**
3. **Generate new token** (classic) 클릭
4. 설정:
   ```
   Note: NLP-Portfolio Local Development
   Expiration: 90 days (또는 No expiration)
   Scopes:
     ✅ repo (Full control of private repositories)
   ```
5. **Generate token** 클릭
6. 토큰 복사 (⚠️ 한 번만 표시됨!)

### 2.2 .env 파일에 추가

```bash
# GitHub
GITHUB_TOKEN=ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

✅ **완료 조건**: `.env`에 `GITHUB_TOKEN` 설정 완료

---

## 3. OpenAI API 키 설정

### 3.1 OpenAI API 키 발급

임베딩 파이프라인은 Hugging Face를 사용하지만, **쿼리 임베딩 생성**을 위해 OpenAI API 키가 필요합니다.

1. [OpenAI Platform](https://platform.openai.com) 로그인
2. **API keys** 메뉴 클릭
3. **Create new secret key** 클릭
4. 이름 입력: `NLP-Portfolio`
5. API 키 복사

### 3.2 .env 파일에 추가

```bash
# OpenAI (쿼리 임베딩용)
OPENAI_API_KEY=sk-proj-xxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

✅ **완료 조건**: `.env`에 `OPENAI_API_KEY` 설정 완료

---

## 4. target-repos.json 설정

### 4.1 설정 파일 생성

프로젝트 루트에 `target-repos.json` 파일 생성:

```json
{
  "repositories": [
    {
      "owner": "YOUR_GITHUB_USERNAME",
      "repo": "portfolio",
      "enabled": true
    },
    {
      "owner": "YOUR_GITHUB_USERNAME",
      "repo": "NLP-portfolio",
      "enabled": true
    }
  ]
}
```

**설명**:
- `owner`: GitHub 사용자명 또는 조직명
- `repo`: 레포지토리 이름
- `enabled`: `true`로 설정하면 임베딩 생성 대상에 포함

### 4.2 본인 레포지토리로 변경

```json
{
  "repositories": [
    {
      "owner": "bongseok-sa",  ← 본인 GitHub 사용자명으로 변경
      "repo": "my-project",    ← 분석할 레포지토리 이름으로 변경
      "enabled": true
    }
  ]
}
```

✅ **완료 조건**: `target-repos.json` 파일 생성 및 설정 완료

---

## 5. 로컬 파이프라인 실행

### 5.1 환경 변수 최종 확인

`.env` 파일에 다음 값들이 모두 설정되어 있어야 합니다:

```bash
# GitHub
GITHUB_TOKEN=ghp_xxxxx

# OpenAI (쿼리 임베딩용)
OPENAI_API_KEY=sk-proj-xxxxx

# Supabase
SUPABASE_URL=https://xxxxx.supabase.co
SUPABASE_SERVICE_ROLE_KEY=eyJhbGci...
SUPABASE_ANON_KEY=eyJhbGci...
```

### 5.2 첫 실행 (리셋 모드)

처음 실행하는 경우 **리셋 모드**로 실행하세요:

```bash
pnpm run embed:reset
```

**예상 출력**:
```
🚀 Starting Unified Embedding Pipeline (RESET MODE)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[Phase 1: Setup & Validation]
✅ Step 1: Configuration loaded
   - Repositories: 2
   - Reset mode: enabled

✅ Step 2: Environment validated
   - GITHUB_TOKEN: ✓
   - OPENAI_API_KEY: ✓
   - SUPABASE_URL: ✓

✅ Step 3: Commit state loaded (reset mode)

[Phase 2: Data Collection]
✅ Step 4: Fetching commits from 2 repositories...
   - bongseok-sa/portfolio: 150 commits
   - bongseok-sa/NLP-portfolio: 72 commits
   Total: 222 commits

✅ Step 5: Fetching commit diffs...
   Progress: 222/222 [████████████████████] 100%

✅ Step 6: Fetching repository files...
   - bongseok-sa/portfolio: 45 files
   - bongseok-sa/NLP-portfolio: 103 files
   Total: 148 files

✅ Step 7: Fetching Q&A history from Supabase...
   - Q&A items: 0 (first run)

[Phase 3: Embedding Generation]
✅ Step 8: Initializing Hugging Face model...
   - Model: sentence-transformers/all-MiniLM-L6-v2
   - Dimensions: 384

✅ Step 9: Generating commit embeddings...
   Progress: 222/222 [████████████████████] 100%

✅ Step 10: Generating file embeddings...
   Progress: 148/148 [████████████████████] 100%

✅ Step 11: Generating Q&A embeddings...
   Skipped (no Q&A history)

[Phase 4: Vector Storage]
✅ Step 12: Saving to Supabase pgvector...
   - Batch size: 100
   - Total vectors: 370
   Progress: 370/370 [████████████████████] 100%

[Phase 5: Data Cleanup]
✅ Step 13: Age-based cleanup (6+ months)
   - Removed: 0 vectors

✅ Step 14: Deleted files cleanup
   - Checked: 2 repositories
   - Removed: 0 vectors

✅ Step 15: Capacity limit enforcement (10MB)
   - Current size: 2.3 MB
   - Within limit: ✓

[Phase 6: Export]
✅ Step 16: Fetching all embeddings from Supabase...
   - Total vectors: 370

✅ Step 17: Generating embeddings.json...
   - File size: 2.1 MB

✅ Step 18: Compressing to embeddings.json.gz...
   - Compressed size: 450 KB
   - Compression ratio: 78.6%

[Phase 7: Finalization]
✅ Step 19: Updating commit-state.json...
   - Last commit: abc123...
   - Last updated: 2026-01-05T10:30:00Z

✅ Step 20: Pipeline completed successfully!

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 Final Statistics:
   - Repositories: 2
   - Commits: 222
   - Files: 148
   - Q&A: 0
   - Total vectors: 370
   - Output file: output/embeddings.json.gz (450 KB)
   - Execution time: 8m 32s
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 5.3 증분 업데이트 실행

이후 실행부터는 **일반 모드**로 실행하세요 (신규 커밋만 처리):

```bash
pnpm run embed
```

**예상 출력** (신규 커밋 없는 경우):
```
🚀 Starting Unified Embedding Pipeline
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ Step 4: Fetching commits from 2 repositories...
   - bongseok-sa/portfolio: 0 new commits
   - bongseok-sa/NLP-portfolio: 0 new commits
   Total: 0 new commits

ℹ️  No new commits found. Skipping embedding generation.

✅ Pipeline completed (no changes)
```

---

## 6. 결과 검증

### 6.1 출력 파일 확인

```bash
# 벡터 파일 존재 확인
ls -lh output/embeddings.json.gz

# 예상 출력:
# -rw-r--r-- 1 user staff 450K Jan 5 10:30 output/embeddings.json.gz
```

### 6.2 벡터 파일 내용 확인

```bash
# 압축 해제 및 통계 확인
zcat output/embeddings.json.gz | jq '.statistics'
```

**예상 출력**:
```json
{
  "totalEmbeddings": 370,
  "commitCount": 222,
  "fileCount": 148,
  "qaCount": 0
}
```

### 6.3 Supabase 데이터 확인

1. Supabase Dashboard → **Table Editor**
2. `embeddings` 테이블 선택
3. 데이터 존재 확인:
   - 총 행 수: 370
   - `type` 값: `commit`, `file` 확인
   - `embedding` 컬럼에 384차원 벡터 확인

✅ **완료 조건**:
- `output/embeddings.json.gz` 파일 생성
- Supabase `embeddings` 테이블에 데이터 저장
- 통계 정보 정상 출력

---

## 7. GitHub Actions CI 설정

### 7.1 워크플로우 파일 생성

**파일**: `.github/workflows/unified-embedding-pipeline.yml`

```yaml
name: Unified Embedding Pipeline

on:
  schedule:
    # 매주 토요일 18:00 UTC 실행 (한국 시간 일요일 03:00)
    - cron: '0 18 * * 6'
  workflow_dispatch:  # 수동 실행 가능
    inputs:
      reset:
        description: 'Reset mode (전체 재생성)'
        required: false
        default: 'false'

jobs:
  embed:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install

      - name: Run embedding pipeline
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # 자동 제공
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          if [ "${{ github.event.inputs.reset }}" == "true" ]; then
            pnpm run embed:reset
          else
            pnpm run embed
          fi

      - name: Commit and push embeddings
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add output/embeddings.json.gz commit-state.json
          git commit -m "chore: update embeddings [skip ci]" || echo "No changes"
          git push
```

### 7.2 GitHub Secrets 설정

1. GitHub 레포지토리 → **Settings** → **Secrets and variables** → **Actions**
2. **New repository secret** 클릭하여 다음 추가:

```
OPENAI_API_KEY = sk-proj-xxxxx
SUPABASE_URL = https://xxxxx.supabase.co
SUPABASE_SERVICE_ROLE_KEY = eyJhbGci...
SUPABASE_ANON_KEY = eyJhbGci...
```

⚠️ **주의**: `GITHUB_TOKEN`은 자동 제공되므로 추가하지 않아도 됩니다.

### 7.3 수동 실행 테스트

1. GitHub 레포지토리 → **Actions** 탭
2. **Unified Embedding Pipeline** 워크플로우 선택
3. **Run workflow** 클릭
4. 실행 결과 확인

✅ **완료 조건**: GitHub Actions 워크플로우 성공

---

## 8. 트러블슈팅

### 문제: "GitHub API rate limit exceeded"
**원인**: GitHub API 호출 제한 초과
**해결**:
- 인증된 요청은 5,000회/시간 제한
- `GITHUB_TOKEN` 설정 확인
- 레포지토리 개수 줄이기

### 문제: "Hugging Face model loading failed"
**원인**: 모델 다운로드 실패 또는 메모리 부족
**해결**:
```bash
# 모델 캐시 삭제
rm -rf ~/.cache/huggingface

# 재실행
pnpm run embed:reset
```

### 문제: "Supabase connection timeout"
**원인**: 네트워크 문제 또는 잘못된 URL
**해결**:
1. `.env`에서 `SUPABASE_URL` 확인
2. Supabase Dashboard에서 프로젝트 상태 확인
3. 방화벽 설정 확인

### 문제: "embeddings.json.gz 파일 너무 큼 (>100MB)"
**원인**: Git 파일 크기 제한
**해결**:
- 데이터 정리 주기 조정 (3개월로 단축)
- 파일 임베딩 필터링 강화
- Git LFS 사용 고려

---

## 9. 다음 단계

임베딩 파이프라인을 구축했다면, 다음 문서로 진행하세요:

👉 **[07_API_서버_구축.md](./07_API_서버_구축.md)** - Vercel Serverless API 서버 구축

---

## 10. 관련 문서

- [임베딩 파이프라인 테스트 결과](../05_api/TEST-EMBEDDING-PIPELINE-CLEANUP.md)
- [CI/CD 워크플로우](../04_ci-cd/01_Workflows.md)

---

**문서 작성 완료**: 2026-01-05
**예상 소요 시간**: 15-30분
**이전 문서**: [05_데이터베이스_설정.md](./05_데이터베이스_설정.md)
**다음 문서**: [07_API_서버_구축.md](./07_API_서버_구축.md)
