# 05. ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • (Supabase)

> **ë¬¸ì„œ ë²„ì „**: v1.0
> **ì‘ì„±ì¼**: 2026-01-05
> **ì´ì „ ë¬¸ì„œ**: [02_ì‹œìŠ¤í…œ_ì•„í‚¤í…ì²˜.md](./02_ì‹œìŠ¤í…œ_ì•„í‚¤í…ì²˜.md)
> **ë‹¤ìŒ ë¬¸ì„œ**: [04_ì„ë² ë”©_íŒŒì´í”„ë¼ì¸_êµ¬ì¶•.md](./04_ì„ë² ë”©_íŒŒì´í”„ë¼ì¸_êµ¬ì¶•.md)
> **ì˜ˆìƒ ì‹œê°„**: 30ë¶„

---

## ğŸ“‹ ëª©ì°¨

1. [Supabase ê³„ì • ìƒì„±](#1-supabase-ê³„ì •-ìƒì„±)
2. [í”„ë¡œì íŠ¸ ìƒì„±](#2-í”„ë¡œì íŠ¸-ìƒì„±)
3. [ìŠ¤í‚¤ë§ˆ ì ìš©](#3-ìŠ¤í‚¤ë§ˆ-ì ìš©)
4. [RLS ì •ì±… ê²€ì¦](#4-rls-ì •ì±…-ê²€ì¦)
5. [API í‚¤ ì„¤ì •](#5-api-í‚¤-ì„¤ì •)
6. [ì—°ê²° í…ŒìŠ¤íŠ¸](#6-ì—°ê²°-í…ŒìŠ¤íŠ¸)

---

## 1. Supabase ê³„ì • ìƒì„±

### 1.1 íšŒì›ê°€ì…

1. [Supabase](https://supabase.com) ì ‘ì†
2. **Start your project** í´ë¦­
3. GitHub ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ (ê¶Œì¥) ë˜ëŠ” ì´ë©”ì¼ë¡œ ê°€ì…
4. ì´ë©”ì¼ ì¸ì¦ ì™„ë£Œ

âœ… **ì™„ë£Œ ì¡°ê±´**: Supabase ëŒ€ì‹œë³´ë“œ ì ‘ì† ê°€ëŠ¥

---

## 2. í”„ë¡œì íŠ¸ ìƒì„±

### 2.1 ìƒˆ í”„ë¡œì íŠ¸ ë§Œë“¤ê¸°

1. ëŒ€ì‹œë³´ë“œì—ì„œ **New Project** í´ë¦­
2. í”„ë¡œì íŠ¸ ì„¤ì •:
   ```
   Name: nlp-portfolio
   Database Password: (ì•ˆì „í•œ ë¹„ë°€ë²ˆí˜¸ ìƒì„±)
   Region: Asia Pacific (Singapore) - ê°€ì¥ ê°€ê¹Œìš´ ë¦¬ì „
   Pricing Plan: Free
   ```
3. **Create new project** í´ë¦­
4. í”„ë¡œì íŠ¸ ìƒì„± ëŒ€ê¸° (ì•½ 2ë¶„)

### 2.2 í”„ë¡œì íŠ¸ URL í™•ì¸

í”„ë¡œì íŠ¸ ìƒì„± ì™„ë£Œ í›„:
1. **Settings** â†’ **API** ë©”ë‰´ í´ë¦­
2. **Project URL** ë³µì‚¬ (ì˜ˆ: `https://xxxxx.supabase.co`)

âœ… **ì™„ë£Œ ì¡°ê±´**: í”„ë¡œì íŠ¸ URL íšë“

---

## 3. ìŠ¤í‚¤ë§ˆ ì ìš©

### 3.1 SQL ì—ë””í„° ì ‘ì†

1. ì™¼ìª½ ë©”ë‰´ì—ì„œ **SQL Editor** í´ë¦­
2. **New query** ë²„íŠ¼ í´ë¦­

### 3.2 ìŠ¤í‚¤ë§ˆ íŒŒì¼ ì‹¤í–‰ ìˆœì„œ

#### Step 1: ì´ˆê¸°í™” (pgvector extension)

**íŒŒì¼**: `docs/03_database/00_tables/00_init.sql`

```sql
-- pgvector extension í™œì„±í™”
CREATE EXTENSION IF NOT EXISTS vector;

-- UUID extension í™œì„±í™”
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- íƒ€ì„ì¡´ ì„¤ì •
SET timezone = 'UTC';
```

**ì‹¤í–‰**:
1. ìœ„ SQLì„ SQL ì—ë””í„°ì— ë¶™ì—¬ë„£ê¸°
2. **Run** ë²„íŠ¼ í´ë¦­
3. âœ… "Success. No rows returned" í™•ì¸

---

#### Step 2: qa_history í…Œì´ë¸” ìƒì„±

**íŒŒì¼**: `docs/03_database/qa_history/00_qa_history.sql`

```sql
-- Q&A íˆìŠ¤í† ë¦¬ í…Œì´ë¸”
CREATE TABLE qa_history (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),

  -- Content
  question TEXT NOT NULL,
  question_summary TEXT,
  answer TEXT NOT NULL,

  -- Classification
  category TEXT,
  category_confidence NUMERIC(3, 2),

  -- Performance metrics
  response_time_ms INTEGER,
  classification_time_ms INTEGER,
  vector_search_time_ms INTEGER,
  llm_generation_time_ms INTEGER,
  db_save_time_ms INTEGER,

  -- Token usage
  token_usage INTEGER,
  prompt_tokens INTEGER,
  completion_tokens INTEGER,
  embedding_tokens INTEGER,

  -- Sources
  sources JSONB,
  num_sources INTEGER,

  -- Session
  session_id TEXT,

  -- Status
  status TEXT DEFAULT 'success' CHECK (status IN ('success', 'partial', 'failed')),
  error_message TEXT,

  -- LLM info
  llm_model TEXT,
  llm_provider TEXT
);

-- ì¸ë±ìŠ¤ ìƒì„±
CREATE INDEX idx_qa_history_created_at ON qa_history(created_at DESC);
CREATE INDEX idx_qa_history_category ON qa_history(category);
CREATE INDEX idx_qa_history_session_id ON qa_history(session_id);
CREATE INDEX idx_qa_history_status ON qa_history(status);

-- RLS í™œì„±í™”
ALTER TABLE qa_history ENABLE ROW LEVEL SECURITY;

-- ì •ì±…: Service Roleì€ ëª¨ë“  ì‘ì—… ê°€ëŠ¥
CREATE POLICY "Service role full access"
  ON qa_history FOR ALL
  TO service_role
  USING (true)
  WITH CHECK (true);

-- ì •ì±…: Anonì€ ì½ê¸°ë§Œ ê°€ëŠ¥
CREATE POLICY "Public read access"
  ON qa_history FOR SELECT
  TO anon
  USING (true);
```

**ì‹¤í–‰**: SQL ì—ë””í„°ì— ë¶™ì—¬ë„£ê¸° â†’ **Run**

âœ… **ì™„ë£Œ ì¡°ê±´**: "Success. No rows returned" í™•ì¸

---

#### Step 3: embeddings í…Œì´ë¸” ìƒì„±

**íŒŒì¼**: `docs/03_database/embeddings/00_embeddings.sql`

```sql
-- ì„ë² ë”© ë²¡í„° í…Œì´ë¸” (CI ì „ìš©)
CREATE TABLE embeddings (
  id TEXT PRIMARY KEY,
  type TEXT NOT NULL CHECK (type IN ('commit', 'file', 'qa')),
  content TEXT NOT NULL,
  embedding vector(384),  -- Hugging Face all-MiniLM-L6-v2
  metadata JSONB,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- ì¸ë±ìŠ¤ ìƒì„±
CREATE INDEX idx_embeddings_type ON embeddings(type);
CREATE INDEX idx_embeddings_created_at ON embeddings(created_at DESC);

-- ë²¡í„° ê²€ìƒ‰ ì¸ë±ìŠ¤ (HNSW - ë¹ ë¥¸ ê²€ìƒ‰)
CREATE INDEX ON embeddings USING hnsw (embedding vector_cosine_ops);

-- RLS í™œì„±í™”
ALTER TABLE embeddings ENABLE ROW LEVEL SECURITY;

-- ì •ì±…: Service Roleë§Œ ëª¨ë“  ì‘ì—… ê°€ëŠ¥
CREATE POLICY "Service role full access"
  ON embeddings FOR ALL
  TO service_role
  USING (true)
  WITH CHECK (true);
```

**ì‹¤í–‰**: SQL ì—ë””í„°ì— ë¶™ì—¬ë„£ê¸° â†’ **Run**

âœ… **ì™„ë£Œ ì¡°ê±´**: "Success. No rows returned" í™•ì¸

---

#### Step 4: ping í…Œì´ë¸” ìƒì„±

**íŒŒì¼**: `docs/03_database/ping/00_ping.sql`

```sql
-- Supabase Free Tier ìœ ì§€ í…Œì´ë¸”
CREATE TABLE ping (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  pinged_at TIMESTAMPTZ DEFAULT now()
);

-- ì¸ë±ìŠ¤ ìƒì„±
CREATE INDEX idx_ping_pinged_at ON ping(pinged_at DESC);

-- RLS í™œì„±í™”
ALTER TABLE ping ENABLE ROW LEVEL SECURITY;

-- ì •ì±…: Service Roleë§Œ ì ‘ê·¼ ê°€ëŠ¥
CREATE POLICY "Service role full access"
  ON ping FOR ALL
  TO service_role
  USING (true)
  WITH CHECK (true);
```

**ì‹¤í–‰**: SQL ì—ë””í„°ì— ë¶™ì—¬ë„£ê¸° â†’ **Run**

âœ… **ì™„ë£Œ ì¡°ê±´**: "Success. No rows returned" í™•ì¸

---

### 3.3 í…Œì´ë¸” ìƒì„± í™•ì¸

1. ì™¼ìª½ ë©”ë‰´ì—ì„œ **Table Editor** í´ë¦­
2. ë‹¤ìŒ í…Œì´ë¸”ë“¤ì´ ë³´ì—¬ì•¼ í•¨:
   - âœ… `qa_history`
   - âœ… `embeddings`
   - âœ… `ping`

---

## 4. RLS ì •ì±… ê²€ì¦

### 4.1 RLS (Row Level Security) í™•ì¸

1. **SQL Editor**ì—ì„œ ë‹¤ìŒ ì¿¼ë¦¬ ì‹¤í–‰:

```sql
-- í…Œì´ë¸”ë³„ RLS í™œì„±í™” ìƒíƒœ í™•ì¸
SELECT schemaname, tablename, rowsecurity
FROM pg_tables
WHERE tablename IN ('qa_history', 'embeddings', 'ping');
```

**ì˜ˆìƒ ì¶œë ¥**:
```
schemaname | tablename    | rowsecurity
-----------+--------------+-------------
public     | qa_history   | true
public     | embeddings   | true
public     | ping         | true
```

### 4.2 ì •ì±… í™•ì¸

```sql
-- ì •ì±… ëª©ë¡ ì¡°íšŒ
SELECT tablename, policyname, cmd
FROM pg_policies
WHERE tablename IN ('qa_history', 'embeddings', 'ping');
```

**ì˜ˆìƒ ì¶œë ¥**:
```
tablename    | policyname                | cmd
-------------+---------------------------+------
qa_history   | Service role full access  | *
qa_history   | Public read access        | SELECT
embeddings   | Service role full access  | *
ping         | Service role full access  | *
```

âœ… **ì™„ë£Œ ì¡°ê±´**: ëª¨ë“  í…Œì´ë¸”ì— RLS í™œì„±í™” ë° ì •ì±… ì ìš© í™•ì¸

---

## 5. API í‚¤ ì„¤ì •

### 5.1 API í‚¤ ë³µì‚¬

1. **Settings** â†’ **API** ë©”ë‰´ í´ë¦­
2. ë‹¤ìŒ ê°’ë“¤ì„ ë³µì‚¬:

```
Project URL: https://xxxxx.supabase.co
anon public key: eyJhbGci...
service_role key: eyJhbGci... (âš ï¸ ì ˆëŒ€ ê³µê°œ ê¸ˆì§€!)
```

### 5.2 .env íŒŒì¼ ì„¤ì •

í”„ë¡œì íŠ¸ ë£¨íŠ¸ì˜ `.env` íŒŒì¼ì— ì¶”ê°€:

```bash
# Supabase
SUPABASE_URL=https://xxxxx.supabase.co
SUPABASE_ANON_KEY=eyJhbGci...  # Public key (í”„ë¡ íŠ¸ì—”ë“œìš©)
SUPABASE_ANON_KEY=eyJhbGci...  # Service key (ë°±ì—”ë“œìš©)
```

âš ï¸ **ì£¼ì˜ì‚¬í•­**:
- `SUPABASE_ANON_KEY`ëŠ” **ì ˆëŒ€ GitHubì— ì»¤ë°‹í•˜ì§€ ë§ˆì„¸ìš”**
- `.gitignore`ì— `.env` íŒŒì¼ì´ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
- Vercel ë°°í¬ ì‹œ í™˜ê²½ ë³€ìˆ˜ì— ë³„ë„ë¡œ ì„¤ì • í•„ìš”

---

## 6. ì—°ê²° í…ŒìŠ¤íŠ¸

### 6.1 ë¡œì»¬ í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸

**íŒŒì¼ ìƒì„±**: `scripts/test-supabase.ts`

```typescript
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';

dotenv.config();

const supabaseUrl = process.env.SUPABASE_URL!;
const supabaseKey = process.env.SUPABASE_ANON_KEY!;

const supabase = createClient(supabaseUrl, supabaseKey);

async function testConnection() {
  console.log('ğŸ”„ Testing Supabase connection...\n');

  // Test 1: Ping í…Œì´ë¸” ì“°ê¸°
  console.log('Test 1: Ping table insert');
  const { data: pingData, error: pingError } = await supabase
    .from('ping')
    .insert({ pinged_at: new Date().toISOString() })
    .select();

  if (pingError) {
    console.error('âŒ Ping insert failed:', pingError.message);
  } else {
    console.log('âœ… Ping insert successful:', pingData);
  }

  // Test 2: qa_history í…Œì´ë¸” ì½ê¸°
  console.log('\nTest 2: QA History read');
  const { data: qaData, error: qaError } = await supabase
    .from('qa_history')
    .select('*')
    .limit(5);

  if (qaError) {
    console.error('âŒ QA History read failed:', qaError.message);
  } else {
    console.log('âœ… QA History read successful. Rows:', qaData.length);
  }

  // Test 3: embeddings í…Œì´ë¸” ì¹´ìš´íŠ¸
  console.log('\nTest 3: Embeddings count');
  const { count, error: countError } = await supabase
    .from('embeddings')
    .select('*', { count: 'exact', head: true });

  if (countError) {
    console.error('âŒ Embeddings count failed:', countError.message);
  } else {
    console.log('âœ… Embeddings count:', count);
  }

  console.log('\nâœ… All tests completed!');
}

testConnection();
```

### 6.2 í…ŒìŠ¤íŠ¸ ì‹¤í–‰

```bash
# í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
pnpm tsx scripts/test-supabase.ts
```

**ì˜ˆìƒ ì¶œë ¥**:
```
ğŸ”„ Testing Supabase connection...

Test 1: Ping table insert
âœ… Ping insert successful: [{ id: '...', pinged_at: '...' }]

Test 2: QA History read
âœ… QA History read successful. Rows: 0

Test 3: Embeddings count
âœ… Embeddings count: 0

âœ… All tests completed!
```

âœ… **ì™„ë£Œ ì¡°ê±´**: ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼

---

## 7. íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ë¬¸ì œ: "relation does not exist"
**ì›ì¸**: í…Œì´ë¸”ì´ ìƒì„±ë˜ì§€ ì•ŠìŒ
**í•´ê²°**:
1. SQL Editorì—ì„œ ìŠ¤í‚¤ë§ˆ íŒŒì¼ ë‹¤ì‹œ ì‹¤í–‰
2. Table Editorì—ì„œ í…Œì´ë¸” í™•ì¸

### ë¬¸ì œ: "permission denied"
**ì›ì¸**: RLS ì •ì±… ë¬¸ì œ ë˜ëŠ” ì˜ëª»ëœ API í‚¤
**í•´ê²°**:
1. `SUPABASE_ANON_KEY` ì‚¬ìš© í™•ì¸ (ANON_KEY ì•„ë‹˜)
2. RLS ì •ì±… ì¬í™•ì¸
3. API í‚¤ ì¬ë³µì‚¬

### ë¬¸ì œ: "Invalid API key"
**ì›ì¸**: í™˜ê²½ ë³€ìˆ˜ ë¯¸ì„¤ì • ë˜ëŠ” ì˜¤íƒ€
**í•´ê²°**:
1. `.env` íŒŒì¼ í™•ì¸
2. API í‚¤ ì•ë’¤ ê³µë°± ì œê±°
3. `dotenv.config()` í˜¸ì¶œ í™•ì¸

---

## 8. ë‹¤ìŒ ë‹¨ê³„

ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •ì„ ì™„ë£Œí–ˆë‹¤ë©´, ë‹¤ìŒ ë¬¸ì„œë¡œ ì§„í–‰í•˜ì„¸ìš”:

ğŸ‘‰ **[04_ì„ë² ë”©_íŒŒì´í”„ë¼ì¸_êµ¬ì¶•.md](./04_ì„ë² ë”©_íŒŒì´í”„ë¼ì¸_êµ¬ì¶•.md)** - GitHub ë°ì´í„° ìˆ˜ì§‘ ë° ì„ë² ë”© ìƒì„±

---

## 9. ê´€ë ¨ ë¬¸ì„œ

- [ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ìƒì„¸](../../CLAUDE.md#schema)

---

**ë¬¸ì„œ ì‘ì„± ì™„ë£Œ**: 2026-01-05
**ì˜ˆìƒ ì†Œìš” ì‹œê°„**: 30ë¶„
**ì´ì „ ë¬¸ì„œ**: [02_ì‹œìŠ¤í…œ_ì•„í‚¤í…ì²˜.md](./02_ì‹œìŠ¤í…œ_ì•„í‚¤í…ì²˜.md)
**ë‹¤ìŒ ë¬¸ì„œ**: [04_ì„ë² ë”©_íŒŒì´í”„ë¼ì¸_êµ¬ì¶•.md](./04_ì„ë² ë”©_íŒŒì´í”„ë¼ì¸_êµ¬ì¶•.md)
