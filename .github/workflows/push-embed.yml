name: Push-based Embedding (Incremental)

# Ìä∏Î¶¨Í±∞: ÌäπÏ†ï Î∏åÎûúÏπòÏóê ÏΩîÎìú push Ïãú
on:
  push:
    branches:
      - main              # ÌîÑÎ°úÎçïÏÖò Î∏åÎûúÏπò
      - develop           # Í∞úÎ∞ú Î∏åÎûúÏπò
    paths:
      - 'src/**'          # ÏÜåÏä§ ÏΩîÎìú Î≥ÄÍ≤Ω ÏãúÎßå
      - '!src/**/*.test.ts'    # ÌÖåÏä§Ìä∏ Ï†úÏô∏
      - '!src/**/*.spec.ts'
      - '!**/*.md'        # Î¨∏ÏÑú Ï†úÏô∏
      - '!docs/**'

  # ÏàòÎèô Ïã§Ìñâ
  workflow_dispatch:
    inputs:
      reset:
        description: 'Force re-embed all commits'
        type: boolean
        default: false

# ÎèôÏãú Ïã§Ìñâ Î∞©ÏßÄ
concurrency:
  group: push-embed-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Ïã§Ìñâ Ïó¨Î∂Ä ÌôïÏù∏ (Ïª§Î∞ã Î©îÏãúÏßÄ Ï≤¥ÌÅ¨)
  check-should-run:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Check commit message
        id: check
        run: |
          # [skip-embed] ÌÉúÍ∑∏Í∞Ä ÏûàÏúºÎ©¥ skip
          if [[ "${{ github.event.head_commit.message }}" =~ \[skip-embed\] ]]; then
            echo "‚è≠Ô∏è  Skipping embedding (found [skip-embed] tag)"
            echo "should_run=false" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Will run embedding pipeline"
            echo "should_run=true" >> $GITHUB_OUTPUT
          fi

  incremental-embed:
    needs: check-should-run
    if: needs.check-should-run.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Push Í∏∞Î∞òÏùÄ 1ÏãúÍ∞Ñ Ï†úÌïú

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.17.1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Ïù¥Ï†Ñ ÏÉÅÌÉú Î≥µÏõê
      - name: Download previous commit state
        uses: actions/download-artifact@v4
        with:
          name: commit-state
          path: .
        continue-on-error: true

      - name: Initialize commit state
        run: |
          if [ -f "commit-state.json" ]; then
            echo "‚úÖ Found previous state"
            cat commit-state.json | jq '.repositories | keys' || echo "{}" > commit-state.json
          else
            echo "‚ö†Ô∏è  No previous state, creating new"
            echo '{"repositories":{},"lastUpdated":"'$(date -Iseconds)'"}' > commit-state.json
          fi

      # Supabase Ïó∞Í≤∞ ÌôïÏù∏
      - name: Verify Supabase connection
        uses: nick-invision/retry@v2
        with:
          timeout_minutes: 2
          max_attempts: 3
          retry_wait_seconds: 10
          command: |
            response=$(curl -s -w "%{http_code}" -o /dev/null \
              -H "apikey: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
              "${{ secrets.SUPABASE_URL }}/rest/v1/")

            if [ "$response" -ge 200 ] && [ "$response" -lt 300 ]; then
              echo "‚úÖ Supabase OK"
            else
              echo "‚ùå Supabase failed (HTTP $response)"
              exit 1
            fi

      # Ï¶ùÎ∂Ñ ÏûÑÎ≤†Îî© Ïã§Ìñâ (Supabase Î™®Îìú - ChromaDB Î∂àÌïÑÏöî)
      - name: Run incremental embedding
        id: embed
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "üöÄ Running incremental embedding (Supabase mode)..."

          if [ "${{ inputs.reset }}" = "true" ]; then
            pnpm run dev --reset 2>&1 | tee pipeline.log
          else
            pnpm run dev 2>&1 | tee pipeline.log
          fi

      # Ïã§Ìñâ Í≤∞Í≥º ÌååÏã±
      - name: Parse results
        if: always()
        id: results
        run: |
          if [ -f "pipeline.log" ]; then
            success=$(grep -c "‚úÖ Successfully processed" pipeline.log || echo "0")
            failure=$(grep -c "‚ùå Failed to process" pipeline.log || echo "0")
            uptodate=$(grep -c "up to date" pipeline.log || echo "0")

            echo "success_count=$success" >> $GITHUB_OUTPUT
            echo "failure_count=$failure" >> $GITHUB_OUTPUT
            echo "uptodate_count=$uptodate" >> $GITHUB_OUTPUT

            echo "üìä Results: Success=$success, Failure=$failure, UpToDate=$uptodate"
          else
            echo "success_count=0" >> $GITHUB_OUTPUT
            echo "failure_count=0" >> $GITHUB_OUTPUT
            echo "uptodate_count=1" >> $GITHUB_OUTPUT
          fi

      # ÏÉÅÌÉú Ï†ÄÏû•
      - name: Upload commit state
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: commit-state
          path: commit-state.json
          retention-days: 90
        continue-on-error: true

      - name: Upload refined data
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: refined-data-push-${{ github.run_number }}
          path: output/refined_data.json
          retention-days: 7
        continue-on-error: true

      # Ïã§Ìå® Ïãú Î°úÍ∑∏ Ï†ÄÏû•
      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-logs-push-${{ github.run_number }}
          path: pipeline.log
          retention-days: 7
        continue-on-error: true

      # Í≤∞Í≥º ÏöîÏïΩ
      - name: Summary
        if: always()
        run: |
          echo "## üöÄ Push-based Embedding Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Success**: ${{ steps.results.outputs.success_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Failure**: ${{ steps.results.outputs.failure_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Up to Date**: ${{ steps.results.outputs.uptodate_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.event.head_commit.message }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Author**: ${{ github.event.head_commit.author.name }}" >> $GITHUB_STEP_SUMMARY

      # ÏÑ±Í≥µ Ïãú ÏûêÎèôÏúºÎ°ú export workflow Ìä∏Î¶¨Í±∞
      - name: Trigger export workflow
        if: success() && steps.results.outputs.success_count > 0
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'export-embeddings.yml',
              ref: 'main'
            });
            console.log('‚úÖ Triggered export workflow');

      - name: Notify
        if: always()
        run: |
          if [ "${{ steps.results.outputs.failure_count }}" -gt 0 ]; then
            echo "‚ö†Ô∏è  Some embeddings failed. Check logs for details."
            exit 1
          elif [ "${{ steps.results.outputs.success_count }}" -gt 0 ]; then
            echo "‚úÖ Embeddings updated successfully!"
          else
            echo "‚úÖ All repositories up to date. No embedding needed."
          fi
