name: Polling-based Embedding Pipeline

# ëª©ì : ì£¼ê¸°ì ìœ¼ë¡œ target-repos.jsonì˜ ì €ì¥ì†Œë“¤ì„ í´ë§í•˜ì—¬ ìƒˆë¡œìš´ ì»¤ë°‹ ê°ì§€ ë° ì„ë² ë”© ìƒì„±
# ì‹¤í–‰ ì£¼ê¸°: ë§¤ì£¼ í† ìš”ì¼ 18:00 UTC (ì¼ìš”ì¼ 03:00 KST)
# ë™ì‘:
#   1. target-repos.json ê¸°ë°˜ ë‹¤ì¤‘ ë ˆí¬ì§€í† ë¦¬ ë³€ê²½ ê°ì§€
#   2. ìƒˆ ì»¤ë°‹ë§Œ ì„ë² ë”© ìƒì„± (ì¦ë¶„ ì—…ë°ì´íŠ¸)
#   3. Supabase pgvectorì— ì €ì¥
#   4. commit-state.json ì—…ë°ì´íŠ¸ (ë‹¤ìŒ ì‹¤í–‰ ì‹œ ì¤‘ë³µ ë°©ì§€)
# íŠ¹ì§•: Idempotent (ë™ì¼ ì»¤ë°‹ ì¬ì‹¤í–‰ ì‹œ ìë™ skip)

on:
  # ë§¤ì£¼ í† ìš”ì¼ 18:00 UTC (ì¼ìš”ì¼ 03:00 KST)
  schedule:
    - cron: "0 18 * * 6"

  # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš© (GitHub Actions UIì—ì„œ ì‹¤í–‰ ê°€ëŠ¥)
  workflow_dispatch:
    inputs:
      reset:
        description: "Reset all commit states and force re-embed (--reset)"
        required: false
        type: boolean
        default: false

# ë™ì‹œ ì‹¤í–‰ ë°©ì§€ (ë¹„ìš© ì ˆê° + ë°ì´í„° ë¬´ê²°ì„±)
concurrency:
  group: embedding-pipeline-${{ github.ref }}
  cancel-in-progress: true

jobs:
  polling-embed:
    name: Poll and Embed Repositories
    runs-on: ubuntu-latest
    timeout-minutes: 300  # 5ì‹œê°„ ì œí•œ (6ì‹œê°„ ì „ ì¢…ë£Œ)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ íˆìŠ¤í† ë¦¬ (ì¦ë¶„ ì—…ë°ì´íŠ¸ ìœ„í•´)

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.17.1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # ì´ì „ ì‹¤í–‰ ìƒíƒœ ë³µì› (ì¦ë¶„ ì—…ë°ì´íŠ¸ì˜ í•µì‹¬)
      - name: Download previous commit state
        uses: actions/download-artifact@v4
        with:
          name: commit-state
          path: .
        continue-on-error: true  # ì²« ì‹¤í–‰ ì‹œ ì—†ì„ ìˆ˜ ìˆìŒ

      - name: Verify commit state
        run: |
          if [ -f "commit-state.json" ]; then
            echo "âœ… Found previous commit state"
            cat commit-state.json | jq '.repositories | keys' || echo "Invalid JSON, will create new state"
          else
            echo "âš ï¸  No previous state, starting fresh"
            echo '{"repositories":{},"lastUpdated":"'$(date -Iseconds)'"}' > commit-state.json
          fi

      # Supabase ì—°ê²° í™•ì¸ (retry 3íšŒ)
      - name: Verify Supabase connection
        uses: nick-invision/retry@v2
        with:
          timeout_minutes: 2
          max_attempts: 3
          retry_wait_seconds: 10
          command: |
            response=$(curl -s -w "%{http_code}" -o /dev/null \
              -H "apikey: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
              -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
              "${{ secrets.SUPABASE_URL }}/rest/v1/")

            if [ "$response" -ge 200 ] && [ "$response" -lt 300 ]; then
              echo "âœ… Supabase connection OK (HTTP $response)"
            else
              echo "âŒ Supabase connection failed (HTTP $response)"
              exit 1
            fi

      - name: Run polling pipeline (normal mode)
        if: ${{ !inputs.reset }}
        id: run_pipeline
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          pnpm run dev 2>&1 | tee pipeline.log
          echo "Pipeline execution completed"

      - name: Run polling pipeline (reset mode)
        if: ${{ inputs.reset }}
        id: run_pipeline_reset
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          pnpm run dev --reset 2>&1 | tee pipeline.log
          echo "Pipeline execution completed"

      # ì‹¤í–‰ ê²°ê³¼ íŒŒì‹±
      - name: Parse execution results
        if: always()
        id: results
        run: |
          if [ -f "pipeline.log" ]; then
            success=$(grep -c "âœ… Successfully processed" pipeline.log || echo "0")
            failure=$(grep -c "âŒ Failed to process" pipeline.log || echo "0")

            echo "success_count=$success" >> $GITHUB_OUTPUT
            echo "failure_count=$failure" >> $GITHUB_OUTPUT

            echo "ğŸ“Š Execution Results:"
            echo "   Success: $success"
            echo "   Failure: $failure"
          else
            echo "âš ï¸  No pipeline log found"
            echo "success_count=0" >> $GITHUB_OUTPUT
            echo "failure_count=0" >> $GITHUB_OUTPUT
          fi

      # ìƒíƒœ ì €ì¥ (ì‹¤íŒ¨í•´ë„ ì €ì¥ - ë‹¤ìŒ ì‹¤í–‰ ì‹œ ë³µì›)
      - name: Upload commit state artifact
        if: always()
        id: upload_state
        uses: actions/upload-artifact@v4
        with:
          name: commit-state
          path: commit-state.json
          retention-days: 90
        continue-on-error: true

      # Artifact ì‹¤íŒ¨ ì‹œ Gitìœ¼ë¡œ fallback
      - name: Fallback commit state to repository
        if: steps.upload_state.outcome == 'failure'
        run: |
          echo "âš ï¸  Artifact upload failed, committing to repository"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add commit-state.json
          git commit -m "chore: Update commit state [skip ci]" || echo "No changes to commit"
          git push || echo "Push failed, state will be lost"

      - name: Upload refined data artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: refined-data-${{ github.run_number }}
          path: output/refined_data.json
          retention-days: 30
        continue-on-error: true

      # ì‹¤í–‰ ë¡œê·¸ ì €ì¥ (ì‹¤íŒ¨ ì‹œ ë””ë²„ê¹…ìš©)
      - name: Upload pipeline logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-logs-${{ github.run_number }}
          path: pipeline.log
          retention-days: 7
        continue-on-error: true

      # ê²°ê³¼ ìš”ì•½
      - name: Summary
        if: always()
        run: |
          echo "## ğŸš€ Embedding Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Success**: ${{ steps.results.outputs.success_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Failure**: ${{ steps.results.outputs.failure_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run Number**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ Polling pipeline failed. Check logs for details."
          echo "ğŸ“Š Results: Success=${{ steps.results.outputs.success_count }}, Failure=${{ steps.results.outputs.failure_count }}"
          exit 1
